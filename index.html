<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PSSI Mentawai</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
    #app { display: none; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; color: white; z-index: 1000; }
    .nav-bottom .nav-link { color: #ccc; font-size: 12px; }
    .nav-bottom .nav-link.active { color: #0d6efd; }
    .page { padding: 10px; padding-bottom: 70px; }
    .card { margin-bottom: 10px; font-size: 13px; }
    .toast { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; min-width: 200px; }
    .modal { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 1055; width: 90%; max-width: 400px; }
    .badge-unread { background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    .user-active::after { content: ''; width: 10px; height: 10px; background: lime; border-radius: 50%; display: inline-block; margin-left: 5px; }
    input, select, textarea { font-size: 14px !important; }
    @media (min-width: 768px) { body::before { content: 'Gunakan perangkat seluler'; display: block; text-align: center; padding: 50px; font-size: 18px; } #app, .nav-bottom { display: none !important; } }
  </style>
</head>
<body>
  <div id="loginPage" class="container page">
    <h4 class="text-center mb-4">Login PSSI Mentawai</h4>
    <input type="text" id="username" class="form-control mb-2" placeholder="Username" />
    <input type="password" id="password" class="form-control mb-3" placeholder="Password" />
    <button onclick="login()" class="btn btn-primary w-100">Login</button>
  </div>

  <div id="app" class="d-none">
    <div id="home" class="page"></div>
    <div id="pemain" class="page d-none"></div>
    <div id="jadwal" class="page d-none"></div>
    <div id="berita" class="page d-none"></div>
    <div id="chat" class="page d-none"></div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Konfirmasi</h5></div>
        <div class="modal-body" id="confirmText"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="confirmYes">Ya</button>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills nav-bottom d-flex justify-content-around py-2">
    <li class="nav-item"><a class="nav-link active" onclick="showPage('home')"><i class="bi bi-house"></i><br>Home</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showPage('pemain')"><i class="bi bi-people"></i><br>Pemain</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showPage('jadwal')"><i class="bi bi-calendar"></i><br>Jadwal</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showPage('berita')"><i class="bi bi-newspaper"></i><br>Berita</a></li>
    <li class="nav-item"><a class="nav-link" onclick="showPage('chat')"><i class="bi bi-chat-dots"></i><br>Chat</a></li>
  </ul>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx05ahOZT41R6hW-DcvuXGJRcY3nM-apyne08nsLFk672iH6HMjRPsvsBktg7Y_jAlx/exec'; // GANTI DENGAN URL WEB APP
    let user = null, sessionId = null;
    let currentChat = null;
    let chatInterval = null;

    window.onload = () => {
      const saved = localStorage.getItem('session');
      if (saved) {
        const {s, u} = JSON.parse(saved);
        sessionId = s; user = u;
        google.script.run.withSuccessHandler(res => {
          if (res.valid) loadHome();
          else showLogin();
        }).checkSession({sessionId: s});
      } else showLogin();
    };

    function showLogin() {
      document.getElementById('loginPage').classList.remove('d-none');
      document.getElementById('app').classList.add('d-none');
    }

    function login() {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return toast('Isi username dan password');
      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          user = res.user; sessionId = res.sessionId;
          localStorage.setItem('session', JSON.stringify({s: sessionId, u: user}));
          document.getElementById('loginPage').classList.add('d-none');
          document.getElementById('app').classList.remove('d-none');
          loadHome();
        } else toast(res.message);
      }).login({username: u, password: p});
    }

    function logout() {
      google.script.run.withSuccessHandler(() => {
        localStorage.clear();
        showLogin();
      }).logout({sessionId});
    }

    function showPage(page) {
      if (chatInterval && page !== 'chat') clearInterval(chatInterval);
      document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
      document.getElementById(page).classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`a[onclick="showPage('${page}')"]`).classList.add('active');
      window[`load${page.charAt(0).toUpperCase() + page.slice(1)}`]();
    }

    function toast(msg, type = 'danger') {
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="toast-body text-white bg-${type}">${msg}</div>`;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // === HOME ===
    function loadHome() {
      const el = document.getElementById('home');
      el.innerHTML = `
        <div class="card mb-3"><div class="card-body">
          <b>${user.nama_lengkap}</b><br>
          ${user.tipe_users} - ${user.id_klub || '-'} - ${user.nama_klub || '-'}
          <button class="btn btn-sm btn-danger float-end" onclick="logout()">Logout</button>
        </div></div>
        <div id="klubForm"></div>
      `;
      if (['ADMIN_KLUB', 'ADMIN_PUSAT'].includes(user.tipe_users)) loadKlubForm();
    }

    function loadKlubForm() {
      google.script.run.withSuccessHandler(res => {
        const el = document.getElementById('klubForm');
        const approved = res.approved;
        el.innerHTML = `<div class="card"><div class="card-body">
          <h6>Data Klub</h6>
          ${generateKlubInputs(res.data, approved)}
          ${!approved ? `<button class="btn btn-primary mt-2" onclick="saveKlub()">Simpan</button>` : ''}
          ${user.tipe_users === 'ADMIN_PUSAT' ? `<button class="btn btn-warning mt-2" onclick="approveKlub('${res.data[0]}', false)">Batalkan Persetujuan</button>` : ''}
        </div></div>`;
      }).getKlubData({id_klub: user.id_klub});
    }

    function generateKlubInputs(data, approved) {
      const fields = ['julukan','tanggal_berdiri','alamat','desa','kecamatan','no_handphone','email','manajer','asisten_manajer','sekretaris','bendahara','pelatih','asisten_pelatih','staff_lainnya'];
      return fields.map((f, i) => `<input type="${f.includes('tanggal') ? 'date' : 'text'}" class="form-control form-control-sm mb-1" id="${f}" value="${data ? data[i+2] || '' : ''}" ${approved ? 'disabled' : ''}>`).join('');
    }

    function saveKlub() {
      const data = {};
      ['julukan','tanggal_berdiri','alamat','desa','kecamatan','no_handphone','email','manajer','asisten_manajer','sekretaris','bendahara','pelatih','asisten_pelatih','staff_lainnya'].forEach(f => data[f] = document.getElementById(f).value);
      google.script.run.withSuccessHandler(res => {
        if (res.success) { toast('Data klub tersimpan', 'success'); loadKlubForm(); }
        else toast(res.message);
      }).saveKlub({user: JSON.stringify(user), ...data});
    }

    function approveKlub(id, approve) {
      google.script.run.withSuccessHandler(() => { toast('Status diperbarui'); loadKlubForm(); }).approveKlub({id_klub: id, approve});
    }

    // === PEMAIN ===
    function loadPemain() {
      const el = document.getElementById('pemain');
      el.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

      google.script.run.withSuccessHandler(res => {
        const klubApproved = res.approved;
        if (!klubApproved && user.tipe_users !== 'ADMIN_PUSAT') {
          el.innerHTML = '<div class="alert alert-warning">Data klub belum disetujui ADMIN_PUSAT.</div>';
          return;
        }

        google.script.run.withSuccessHandler(pemain => {
          el.innerHTML = `
            <div class="card mb-3">
              <div class="card-body">
                <h6>Pemain Kolektif</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered" id="pemainTable">
                    <thead class="table-light"><tr>
                      <th>ID</th><th>Nama</th><th>Punggung</th><th>No</th><th>Lahir</th><th>Ket</th><th>Aksi</th>
                    </tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <button class="btn btn-sm btn-primary" onclick="addPemainRow()">+ Tambah</button>
                <button class="btn btn-sm btn-success mt-1" onclick="saveAllPemain()">Simpan</button>
              </div>
            </div>`;

          const tbody = el.querySelector('#pemainTable tbody');
          pemain.forEach(p => addPemainRow(p));
          for (let i = pemain.length; i < 25; i++) addPemainRow();
        }).getPemain({id_klub: user.id_klub});
      }).getKlubData({id_klub: user.id_klub});
    }

    function addPemainRow(data = null) {
      const tbody = document.querySelector('#pemainTable tbody');
      const isApproved = data && data.approved;
      const disabled = isApproved && user.tipe_users !== 'ADMIN_PUSAT' ? 'disabled' : '';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="number" class="form-control form-control-sm id_pemain" value="${data?.id_pemain || ''}" ${disabled}></td>
        <td><input type="text" class="form-control form-control-sm nama" value="${data?.nama_lengkap || ''}" ${disabled}></td>
        <td><input type="text" class="form-control form-control-sm punggung" value="${data?.nama_punggung || ''}" ${disabled}></td>
        <td><input type="number" class="form-control form-control-sm no" value="${data?.no_punggung || ''}" ${disabled}></td>
        <td><input type="date" class="form-control form-control-sm lahir" value="${data?.tgl_lahir || ''}" ${disabled}></td>
        <td><input type="text" class="form-control form-control-sm ket" value="${data?.keterangan || ''}" ${disabled}></td>
        <td>
          ${user.tipe_users === 'ADMIN_PUSAT' ? `
            <button class="btn btn-sm btn-${isApproved ? 'warning' : 'success'}" onclick="approvePemain(this, '${data?.id_pemain}', ${!isApproved})">
              ${isApproved ? 'Batal' : 'Setujui'}
            </button>` : ''}
        </td>`;
      tbody.appendChild(row);
    }

    function saveAllPemain() {
      const rows = document.querySelectorAll('#pemainTable tbody tr');
      const pemain = [];
      const ids = new Set();

      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const id = inputs[0].value.trim();
        if (id && !ids.has(id)) {
          ids.add(id);
          pemain.push({
            id_pemain: id,
            nama_lengkap: inputs[1].value,
            nama_punggung: inputs[2].value,
            no_punggung: inputs[3].value,
            tgl_lahir: inputs[4].value,
            keterangan: inputs[5].value
          });
        }
      });

      if (pemain.length === 0) return toast('Tidak ada data untuk disimpan');

      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          toast('Pemain disimpan', 'success');
          loadPemain();
        }
      }).savePemain({id_klub: user.id_klub, pemain: JSON.stringify(pemain)});
    }

    function approvePemain(btn, id, approve) {
      google.script.run.withSuccessHandler(() => {
        toast(approve ? 'Disetujui' : 'Dibatalkan', 'info');
        loadPemain();
      }).approvePemain({id_pemain: id, approve});
    }

    // === JADWAL ===
    function loadJadwal() {
      const el = document.getElementById('jadwal');
      el.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

      if (user.tipe_users === 'ADMIN_PUSAT') {
        loadJadwalAdminPusat();
      } else {
        loadJadwalKlub();
      }
    }

    function loadJadwalKlub() {
      google.script.run.withSuccessHandler(jadwal => {
        const el = document.getElementById('jadwal');
        el.innerHTML = jadwal.length === 0 ? '<div class="alert alert-info">Tidak ada jadwal</div>' : '';
        jadwal.forEach(j => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          card.innerHTML = `
            <div class="card-body p-2">
              <h6 class="mb-1">${j.nama_klub} - ${j.type}</h6>
              <small>${new Date(j.tgl).toLocaleDateString('id-ID')} | ${j.lokasi}</small>
              <button class="btn btn-sm btn-primary float-end" onclick="openPendaftaran('${j.id_pertandingan}')">Daftar</button>
            </div>`;
          el.appendChild(card);
        });
      }).getJadwal({id_klub: user.id_klub});
    }

    function loadJadwalAdminPusat() {
      google.script.run.withSuccessHandler(jadwal => {
        const el = document.getElementById('jadwal');
        el.innerHTML = `
          <div class="card mb-3">
            <div class="card-body">
              <h6>Buat Jadwal Baru</h6>
              <input type="date" id="newTgl" class="form-control form-control-sm mb-1">
              <input type="date" id="newBatasAwal" class="form-control form-control-sm mb-1">
              <input type="date" id="newBatasAkhir" class="form-control form-control-sm mb-1">
              <select id="newType" class="form-control form-control-sm mb-1">
                <option>Babak Kualifikasi</option><option>Babak Penyisihan</option><option>16 Besar</option><option>Semifinal</option><option>Final</option>
              </select>
              <input type="text" id="newIdKlub" placeholder="ID Klub" class="form-control form-control-sm mb-1">
              <input type="text" id="newNamaKlub" placeholder="Nama Klub" class="form-control form-control-sm mb-1">
              <input type="text" id="newLokasi" placeholder="Lokasi" class="form-control form-control-sm mb-1">
              <button class="btn btn-sm btn-success" onclick="saveNewJadwal()">Simpan</button>
            </div>
          </div>`;
        
        jadwal.forEach(j => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          card.innerHTML = `
            <div class="card-body p-2">
              <b>${j.id_pertandingan}</b> - ${j.type}<br>
              <small>${new Date(j.tgl).toLocaleDateString('id-ID')} | ${j.nama_klub}</small>
              <button class="btn btn-sm btn-danger float-end" onclick="hapusJadwal('${j.id_pertandingan}')">Hapus</button>
            </div>`;
          el.appendChild(card);
        });
      }).getAllJadwal();
    }

    function saveNewJadwal() {
      const data = {
        tgl: document.getElementById('newTgl').value,
        batas_awal: document.getElementById('newBatasAwal').value,
        batas_akhir: document.getElementById('newBatasAkhir').value,
        type: document.getElementById('newType').value,
        id_klub: document.getElementById('newIdKlub').value,
        nama_klub: document.getElementById('newNamaKlub').value,
        lokasi: document.getElementById('newLokasi').value
      };
      google.script.run.withSuccessHandler(() => {
        toast('Jadwal dibuat', 'success');
        loadJadwal();
      }).saveJadwal(data);
    }

    function hapusJadwal(id) {
      if (confirm('Hapus jadwal ini?')) {
        google.script.run.withSuccessHandler(() => {
          toast('Dihapus');
          loadJadwal();
        }).deleteJadwal(id);
      }
    }

    function openPendaftaran(id_pertandingan) {
      sessionStorage.setItem('current_match', id_pertandingan);
      showPage('jadwal');
      loadPendaftaranForm(id_pertandingan);
    }

    function loadPendaftaranForm(id_pertandingan) {
      const el = document.getElementById('jadwal');
      el.innerHTML = `<div class="card"><div class="card-body">
        <h6>Pendaftaran Pemain - ${id_pertandingan}</h6>
        <button class="btn btn-sm btn-secondary mb-2" onclick="loadJadwal()">Kembali</button>
        <div class="table-responsive">
          <table class="table table-sm" id="daftarTable">
            <thead class="table-light"><tr>
              <th>Pemain</th><th>No</th><th>Posisi</th><th>Tipe</th><th>Aksi</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <button class="btn btn-sm btn-primary" onclick="addDaftarRow()">+ Pemain</button>
        <button class="btn btn-sm btn-success" onclick="saveDaftar()">Simpan</button>
      </div></div>`;

      google.script.run.withSuccessHandler(daftar => {
        const tbody = document.querySelector('#daftarTable tbody');
        daftar.forEach(d => addDaftarRow(d));
        for (let i = daftar.length; i < 25; i++) addDaftarRow();
      }).getPendaftaran({id_pertandingan, id_klub: user.id_klub});
    }

    function addDaftarRow(data = null) {
      const tbody = document.querySelector('#daftarTable tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <select class="form-control form-control-sm pemain-select" ${data?.approved ? 'disabled' : ''}>
            <option value="">Pilih Pemain</option>
          </select>
        </td>
        <td><input type="number" class="form-control form-control-sm no" value="${data?.no_punggung || ''}" ${data?.approved ? 'disabled' : ''}></td>
        <td><input type="text" class="form-control form-control-sm posisi" value="${data?.posisi || ''}" ${data?.approved ? 'disabled' : ''}></td>
        <td>
          <select class="form-control form-control-sm tipe" ${data?.approved ? 'disabled' : ''}>
            <option ${data?.tipe === 'PEMAIN UTAMA' ? 'selected' : ''}>PEMAIN UTAMA</option>
            <option ${data?.tipe === 'PEMAIN CADANGAN' ? 'selected' : ''}>PEMAIN CADANGAN</option>
          </select>
        </td>
        <td>
          ${user.tipe_users === 'ADMIN_PUSAT' ? `<button class="btn btn-sm btn-${data?.approved ? 'warning' : 'success'}" onclick="approveDaftar(this, '${data?.id_pemain}', ${!data?.approved})">${data?.approved ? 'Batal' : 'Setujui'}</button>` : ''}
        </td>`;
      tbody.appendChild(row);

      google.script.run.withSuccessHandler(pemain => {
        const select = row.querySelector('.pemain-select');
        pemain.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id_pemain;
          opt.text = `${p.id_pemain} - ${p.nama_lengkap}`;
          if (data && data.id_pemain === p.id_pemain) opt.selected = true;
          select.appendChild(opt);
        });
        select.onchange = () => {
          const selected = pemain.find(p => p.id_pemain == select.value);
          if (selected) {
            row.querySelector('.no').value = selected.no_punggung;
            row.querySelector('.posisi').value = selected.keterangan || '';
          }
        };
      }).getPemain({id_klub: user.id_klub});
    }

    function saveDaftar() {
      const rows = document.querySelectorAll('#daftarTable tbody tr');
      const daftar = [];
      const ids = new Set();

      rows.forEach(row => {
        const select = row.querySelector('.pemain-select');
        const id = select.value;
        if (id && !ids.has(id)) {
          ids.add(id);
          daftar.push({
            id_pemain: id,
            nama_punggung: select.options[select.selectedIndex].text.split(' - ')[1],
            no_punggung: row.querySelector('.no').value,
            posisi: row.querySelector('.posisi').value,
            tipe: row.querySelector('.tipe').value
          });
        }
      });

      const id_pertandingan = sessionStorage.getItem('current_match');
      google.script.run.withSuccessHandler(() => {
        toast('Pendaftaran disimpan', 'success');
        loadPendaftaranForm(id_pertandingan);
      }).savePendaftaran({id_pertandingan, id_klub: user.id_klub, daftar: JSON.stringify(daftar)});
    }

    // === BERITA ===
    function loadBerita() {
      const el = document.getElementById('berita');
      el.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

      google.script.run.withSuccessHandler(berita => {
        el.innerHTML = `
          <div class="card mb-3">
            <div class="card-body">
              <h6>Buat Berita Baru</h6>
              <input type="text" id="judulBerita" placeholder="Judul" class="form-control form-control-sm mb-1">
              <textarea id="isiBerita" placeholder="Isi berita" class="form-control form-control-sm mb-1" rows="3"></textarea>
              <input type="url" id="fotoUrl" placeholder="URL Foto (imgbb)" class="form-control form-control-sm mb-1">
              <button class="btn btn-sm btn-success" onclick="saveBeritaBaru()">Publikasikan</button>
            </div>
          </div>`;

        berita.forEach(b => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          card.innerHTML = `
            <div class="card-body p-2">
              <h6 class="mb-1">${b.judul}</h6>
              <small class="text-muted">${new Date(b.tgl).toLocaleDateString('id-ID')} - ${b.penulis}</small>
              <p class="mt-1 mb-2" style="font-size:13px;">${b.isi}</p>
              ${b.foto ? `<img src="${b.foto}" class="img-fluid rounded" style="max-height:150px;">` : ''}
            </div>`;
          el.appendChild(card);
        });
      }).getBerita();
    }

    function saveBeritaBaru() {
      const judul = document.getElementById('judulBerita').value;
      const isi = document.getElementById('isiBerita').value;
      const foto = document.getElementById('fotoUrl').value;
      if (!judul || !isi) return toast('Judul dan isi wajib diisi');

      google.script.run.withSuccessHandler(() => {
        toast('Berita dipublikasikan', 'success');
        loadBerita();
      }).saveBerita({judul, isi, foto, penulis: user.nama_lengkap});
    }

    // === CHAT ===
    function loadChat() {
      const el = document.getElementById('chat');
      el.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

      google.script.run.withSuccessHandler(users => {
        el.innerHTML = '<div id="chatList"></div>';
        const list = document.getElementById('chatList');
        users.forEach(u => {
          const div = document.createElement('div');
          div.className = 'd-flex justify-content-between align-items-center p-2 border-bottom';
          div.onclick = () => openChatWith(u.username, u.nama);
          div.innerHTML = `
            <div>
              <b>${u.nama}</b><span class="${u.active ? 'user-active' : ''}"></span>
            </div>
            <span id="badge_${u.username}" class="badge-unread d-none">0</span>`;
          list.appendChild(div);
        });
        startChatPolling();
      }).getChatUsers({username: user.username});
    }

    function openChatWith(username, nama) {
      currentChat = {username, nama};
      const el = document.getElementById('chat');
      el.innerHTML = `
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <b>${nama}</b>
            <button class="btn btn-sm btn-secondary" onclick="loadChat()">Kembali</button>
          </div>
          <div class="card-body p-2" id="chatMessages" style="height:60vh; overflow-y:auto; font-size:13px;"></div>
          <div class="card-footer p-2">
            <div class="input-group">
              <input type="text" id="msgInput" class="form-control form-control-sm" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendChat()">
              <button class="btn btn-primary btn-sm" onclick="sendChat()">Kirim</button>
            </div>
          </div>
        </div>`;
      loadMessages();
      markAsRead();
    }

    function loadMessages() {
      if (!currentChat) return;
      google.script.run.withSuccessHandler(msgs => {
        const box = document.getElementById('chatMessages');
        box.innerHTML = '';
        msgs.forEach(m => {
          const div = document.createElement('div');
          div.className = `mb-2 ${m.pengirim === user.username ? 'text-end' : ''}`;
          div.innerHTML = `
            <div class="d-inline-block p-2 rounded ${m.pengirim === user.username ? 'bg-primary text-white' : 'bg-light'}" style="max-width:80%;">
              <small class="d-block">${m.pengirim === user.username ? 'Anda' : currentChat.nama}</small>
              ${m.pesan}
              <small class="d-block text-end" style="font-size:10px;">${new Date(m.timestamp).toLocaleTimeString('id-ID')}</small>
            </div>`;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      }).getMessages({sender: user.username, receiver: currentChat.username});
    }

    function sendChat() {
      const input = document.getElementById('msgInput');
      const pesan = input.value.trim();
      if (!pesan) return;
      google.script.run.withSuccessHandler(() => {
        input.value = '';
        loadMessages();
        updateBadge(currentChat.username, true);
      }).sendMessage({sender: user.username, receiver: currentChat.username, pesan});
    }

    function markAsRead() {
      if (!currentChat) return;
      google.script.run.withSuccessHandler(() => {
        updateBadge(currentChat.username, false);
      }).markAsRead({sender: currentChat.username, receiver: user.username});
    }

    function startChatPolling() {
      chatInterval = setInterval(() => {
        if (currentChat) loadMessages();
        updateAllBadges();
      }, 3000);
    }

    function updateAllBadges() {
      google.script.run.withSuccessHandler(users => {
        users.forEach(u => {
          google.script.run.withSuccessHandler(msgs => {
            const count = msgs.filter(m => m.is_read === 'NO').length;
            const badge = document.getElementById(`badge_${u.username}`);
            if (badge) {
              badge.textContent = count;
              badge.classList.toggle('d-none', count === 0);
            }
          }).getMessages({sender: u.username, receiver: user.username});
        });
      }).getChatUsers({username: user.username});
    }

    function updateBadge(username, increment) {
      const badge = document.getElementById(`badge_${username}`);
      if (!badge) return;
      let count = parseInt(badge.textContent) || 0;
      badge.textContent = increment ? count + 1 : 0;
      badge.classList.toggle('d-none', count === 0 && !increment);
    }

    // Back button
    window.addEventListener('popstate', () => {
      const pages = ['home','pemain','jadwal','berita','chat'];
      const current = pages.find(p => !document.getElementById(p).classList.contains('d-none'));
      const idx = pages.indexOf(current);
      if (idx > 0) showPage(pages[idx - 1]);
    });

    // Inisialisasi Google Apps Script
    (function() { 
      const s = document.createElement('script'); 
      s.src = SCRIPT_URL + '?v=' + new Date().getTime(); 
      document.head.appendChild(s); 
    })();
  </script>
</body>
</html>
