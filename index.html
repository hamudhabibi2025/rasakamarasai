<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PSSI Mentawai</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #0066cc; --success: #28a745; --danger: #dc3545; --warning: #ffc107;
      --dark: #343a40; --light: #f8f9fa; --gray: #6c757d; --border: #ddd;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
    body { background:#f4f6f9; color:#333; min-height:100vh; display:flex; flex-direction:column; }
    .container { flex:1; padding:1rem; max-width:1200px; margin:auto; width:100%; }
    .card { background:white; border-radius:12px; padding:1rem; margin-bottom:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .btn { padding:0.6rem 1rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:0.3s; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-success { background:var(--success); color:white; }
    .btn-danger { background:var(--danger); color:white; }
    .btn-warning { background:var(--warning); color:#212529; }
    .btn-sm { padding:0.4rem 0.8rem; font-size:0.85rem; }
    .form-control, select, input, textarea { width:100%; padding:0.6rem; border:1px solid var(--border); border-radius:8px; margin:0.5rem 0; font-size:0.95rem; }
    .form-group { margin-bottom:1rem; }
    label { display:block; margin-bottom:0.3rem; font-weight:600; font-size:0.9rem; }
    .text-center { text-align:center; }
    .d-none { display:none !important; }
    .nav-bottom { position:fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #eee; display:flex; justify-content:space-around; padding:0.5rem 0; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:1000; }
    .nav-item { text-align:center; color:var(--gray); font-size:0.8rem; padding:0.4rem; flex:1; cursor:pointer; }
    .nav-item.active { color:var(--primary); }
    .nav-item i { font-size:1.3rem; display:block; margin-bottom:0.2rem; }
    .badge { background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; display:inline-flex; align-items:center; justify-content:center; position:absolute; top:-6px; right:-6px; }
    .chat-item { position:relative; }
    .online-dot { width:10px; height:10px; background:#0f0; border-radius:50%; position:absolute; top:12px; left:38px; border:2px solid white; box-shadow:0 0 0 1px #0f0; animation:pulse 2s infinite; }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(0,255,0,0.7)} 70%{box-shadow:0 0 0 8px rgba(0,255,0,0)} 100%{box-shadow:0 0 0 0 rgba(0,255,0,0)} }
    .toast, .modal { position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); background:white; padding:1rem 1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.2); z-index:2000; max-width:90%; text-align:center; }
    .toast { background:var(--success); color:white; }
    .modal { background:white; color:#333; }
    .modal button { margin:0.5rem; }
    .loading { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; z-index:3000; }
    .card-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem; }
    .match-card { cursor:pointer; transition:0.2s; border:1px solid #eee; }
    .match-card:hover { transform:translateY(-4px); box-shadow:0 8px 16px rgba(0,0,0,0.15); }
    .empty-row { height:40px; border-bottom:1px dashed #ddd; display:flex; align-items:center; padding:0 0.5rem; color:#aaa; font-style:italic; }
    .table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
    .table th, .table td { padding:0.5rem; border:1px solid #eee; text-align:left; font-size:0.9rem; }
    .table th { background:#f8f9fa; }
    .chat-box { height:60vh; overflow-y:auto; padding:1rem; background:#f9f9f9; border-radius:8px; margin-bottom:0.5rem; }
    .msg { max-width:80%; padding:0.6rem 1rem; border-radius:18px; margin:0.4rem 0; word-wrap:break-word; }
    .msg.sent { background:var(--primary); color:white; margin-left:auto; border-bottom-right-radius:4px; }
    .msg.received { background:#e9ecef; color:#333; margin-right:auto; border-bottom-left-radius:4px; }
    .msg-time { font-size:0.7rem; opacity:0.7; margin-top:0.2rem; }
    .unread { font-weight:bold; }
    .img-preview { max-width:100%; max-height:200px; margin:0.5rem 0; border-radius:8px; }
    @media (max-width: 600px) {
      .container { padding:0.5rem; }
      .form-control, .btn, select { font-size:0.9rem; }
      label { font-size:0.85rem; }
      .table { font-size:0.8rem; }
      .chat-box { height:50vh; }
    }
  </style>
</head>
<body>

<div id="loading" class="loading d-none">
  <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i>
</div>

<!-- LOGIN -->
<div id="loginForm" class="container">
  <div class="card">
    <h2 class="text-center">Login PSSI Mentawai</h2>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="username" class="form-control" />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" class="form-control" />
    </div>
    <button onclick="login()" class="btn btn-primary" style="width:100%">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="d-none">
  <div class="container">
    <div id="page-home" class="page"></div>
    <div id="page-pemain" class="page d-none"></div>
    <div id="page-jadwal" class="page d-none"></div>
    <div id="page-berita" class="page d-none"></div>
    <div id="page-chat" class="page d-none"></div>
    <div id="page-chat-detail" class="page d-none"></div>
  </div>

  <div class="nav-bottom">
    <div class="nav-item active" onclick="showPage('home')"><i class="fas fa-home"></i><span>Home</span></div>
    <div class="nav-item" onclick="showPage('pemain')"><i class="fas fa-users"></i><span>Pemain</span></div>
    <div class="nav-item" onclick="showPage('jadwal')"><i class="fas fa-calendar"></i><span>Jadwal</span></div>
    <div class="nav-item" onclick="showPage('berita')"><i class="fas fa-newspaper"></i><span>Berita</span></div>
    <div class="nav-item" onclick="showPage('chat')">
      <div class="chat-item">
        <i class="fas fa-comments"></i><span>Chat</span>
        <div id="chatBadge" class="badge d-none">0</div>
      </div>
    </div>
  </div>
</div>

<script>
  // === GLOBALS ===
  let currentUser = null;
  let sessionId = localStorage.getItem('sessionId');
  let currentPage = 'home';
  let historyStack = ['home'];
  let selectedMatch = null;
  let chatWith = null;
  const IMGBB_KEY = 'YOUR_IMGBB_API_KEY'; // Ganti dengan API Key imgbb Anda

  window.onload = () => {
    if (sessionId) checkSession();
    else showLogin();
    setupBackButton();
    setInterval(refreshChatBadge, 5000);
  };

  // === UTILS ===
  function showLoading(show = true) {
    document.getElementById('loading').classList.toggle('d-none', !show);
  }

  function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = type === 'danger' ? 'var(--danger)' : 'var(--success)';
    toast.innerText = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function showModal(title, msg, onConfirm, onCancel) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `<h3>${title}</h3><p>${msg}</p>
      <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove(); ${onConfirm || ''}">OK</button>
      ${onCancel ? `<button class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); ${onCancel}">Batal</button>` : ''}`;
    document.body.appendChild(modal);
  }

  function $(id) { return document.getElementById(id); }

  // === AUTH ===
  function login() {
    const u = $('username').value.trim(), p = $('password').value;
    if (!u || !p) return showToast('Isi username dan password', 'danger');
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      if (res.success) {
        currentUser = res.user; sessionId = res.sessionId;
        localStorage.setItem('sessionId', sessionId);
        $('loginForm').classList.add('d-none');
        $('app').classList.remove('d-none');
        loadPage('home');
        startSessionCheck();
      } else showToast(res.message || 'Login gagal', 'danger');
    }).login(u, p);
  }

  function checkSession() {
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      if (res.valid) {
        currentUser = res.user;
        $('loginForm').classList.add('d-none');
        $('app').classList.remove('d-none');
        loadPage('home');
        startSessionCheck();
      } else logout();
    }).checkSession(sessionId);
  }

  function logout() {
    if (sessionId) google.script.run.logout(sessionId);
    localStorage.removeItem('sessionId');
    sessionId = null; currentUser = null;
    $('app').classList.add('d-none');
    $('loginForm').classList.remove('d-none');
    stopSessionCheck();
  }

  let sessionInterval;
  function startSessionCheck() {
    sessionInterval = setInterval(() => {
      google.script.run.withSuccessHandler(res => {
        if (!res.valid) { showToast('Sesi habis', 'danger'); logout(); }
      }).checkSession(sessionId);
    }, 60000);
  }
  function stopSessionCheck() { clearInterval(sessionInterval); }

  // === NAVIGATION ===
  function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
    $(`page-${page}`).classList.remove('d-none');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`.nav-item[onclick="showPage('${page}')"]`)?.classList.add('active');
    currentPage = page;
    historyStack.push(page);
    loadPage(page);
  }

  function goBack() {
    if (historyStack.length > 1) {
      historyStack.pop();
      const prev = historyStack[historyStack.length - 1];
      showPage(prev);
    }
  }

  function setupBackButton() {
    window.addEventListener('popstate', () => {
      if (historyStack.length > 1) goBack();
    });
  }

  // === PAGE LOADERS ===
  function loadPage(page) {
    const el = $(`page-${page}`);
    el.innerHTML = '<div class="card"><p>Memuat...</p></div>';
    setTimeout(() => {
      if (page === 'home') loadHome();
      else if (page === 'pemain') loadPemain();
      else if (page === 'jadwal') loadJadwal();
      else if (page === 'berita') loadBerita();
      else if (page === 'chat') loadChatList();
    }, 100);
  }

  // === HOME - A1 KLUB ===
  function loadHome() {
    const el = $('page-home');
    google.script.run.withSuccessHandler(klub => {
      const isAdminPusat = currentUser.tipeUser === 'ADMIN_PUSAT';
      const isAdminKlub = currentUser.tipeUser === 'ADMIN_KLUB';
      const canEdit = isAdminPusat || (isAdminKlub && (!klub || klub.STATUS_SETUJUI !== 'DISETUJUI'));

      el.innerHTML = `
        <div class="card">
          <h3>Selamat Datang, ${currentUser.namaLengkap}</h3>
          <p><strong>TIPE:</strong> ${currentUser.tipeUser}<br>
             <strong>ID Klub:</strong> ${currentUser.idKlub}<br>
             <strong>Nama Klub:</strong> ${currentUser.namaKlub}</p>
          <button class="btn btn-primary" onclick="openKlubForm(${klub ? JSON.stringify(klub) : 'null'})">Kelola Data Klub</button>
        </div>`;
    }).getKlubData(currentUser.idKlub);
  }

  function openKlubForm(klub) {
    const form = `
      <div class="card">
        <h3>${klub ? 'Edit' : 'Tambah'} Data Klub</h3>
        <div class="form-group"><label>Julukan</label><input id="julukan" value="${klub?.JULUKAN || ''}" class="form-control"></div>
        <div class="form-group"><label>Tanggal Berdiri</label><input type="date" id="tglBerdiri" value="${klub?.TANGGAL_BERDIRI || ''}" class="form-control"></div>
        <div class="form-group"><label>Alamat</label><input id="alamat" value="${klub?.ALAMAT || ''}" class="form-control"></div>
        <div class="form-group"><label>Desa</label><input id="desa" value="${klub?.DESA || ''}" class="form-control"></div>
        <div class="form-group"><label>Kecamatan</label><input id="kecamatan" value="${klub?.KECAMATAN || ''}" class="form-control"></div>
        <div class="form-group"><label>No HP</label><input type="number" id="nohp" value="${klub?.NO_HANDPHONE || ''}" class="form-control"></div>
        <div class="form-group"><label>Email</label><input type="email" id="email" value="${klub?.EMAIL || ''}" class="form-control"></div>
        <div class="form-group"><label>Manajer</label><input id="manajer" value="${klub?.MANAJER || ''}" class="form-control"></div>
        <div class="form-group"><label>Asisten Manajer</label><input id="asman" value="${klub?.ASISTEN_MANAJER || ''}" class="form-control"></div>
        <div class="form-group"><label>Sekretaris</label><input id="sekretaris" value="${klub?.SEKRETARIS || ''}" class="form-control"></div>
        <div class="form-group"><label>Bendahara</label><input id="bendahara" value="${klub?.BENDAHARA || ''}" class="form-control"></div>
        <div class="form-group"><label>Pelatih</label><input id="pelatih" value="${klub?.PELATIH || ''}" class="form-control"></div>
        <div class="form-group"><label>Asisten Pelatih</label><input id="aspel" value="${klub?.ASISTEN_PELATIH || ''}" class="form-control"></div>
        <div class="form-group"><label>Staff Lain</label><input id="staff" value="${klub?.STAFF_LAINNYA || ''}" class="form-control"></div>
        <button class="btn btn-success" onclick="saveKlub()">Simpan</button>
        <button class="btn btn-danger" onclick="loadHome()">Batal</button>
      </div>`;
    $('page-home').innerHTML = form;
  }

  function saveKlub() {
    const data = {
      JULUKAN: $('julukan').value,
      TANGGAL_BERDIRI: $('tglBerdiri').value,
      ALAMAT: $('alamat').value,
      DESA: $('desa').value,
      KECAMATAN: $('kecamatan').value,
      NO_HANDPHONE: $('nohp').value,
      EMAIL: $('email').value,
      MANAJER: $('manajer').value,
      ASISTEN_MANAJER: $('asman').value,
      SEKRETARIS: $('sekretaris').value,
      BENDAHARA: $('bendahara').value,
      PELATIH: $('pelatih').value,
      ASISTEN_PELATIH: $('aspel').value,
      STAFF_LAINNYA: $('staff').value
    };
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      if (res.success) {
        showToast('Data klub disimpan');
        loadHome();
      } else showToast(res.message || 'Gagal simpan', 'danger');
    }).saveKlubData(data, currentUser);
  }

  // === PEMAIN - A2 ===
  function loadPemain() {
    const el = $('page-pemain');
    google.script.run.withSuccessHandler(pemain => {
      google.script.run.withSuccessHandler(klub => {
        if (!klub || klub.STATUS_SETUJUI !== 'DISETUJUI') {
          el.innerHTML = `<div class="card"><p>Data klub belum disetujui oleh Admin Pusat.</p></div>`;
          return;
        }
        let rows = '';
        const usedIds = pemain.map(p => p.ID_PEMAIN);
        for (let i = 0; i < 25; i++) {
          const p = pemain[i] || {};
          rows += `
            <tr>
              <td><input type="number" value="${p.ID_PEMAIN || ''}" onchange="checkDuplicate(this, ${usedIds.join(',')})" class="form-control"></td>
              <td><input value="${p.NAMA_LENGKAP || ''}" class="form-control"></td>
              <td><input value="${p.NAMA_PUNGGUNG || ''}" class="form-control"></td>
              <td><input type="number" value="${p.NO_PUNGGUNG || ''}" class="form-control"></td>
              <td><input type="date" value="${p.TANGGAL_LAHIR || ''}" class="form-control"></td>
              <td><input value="${p.KETERANGAN || ''}" class="form-control"></td>
              <td><button class="btn btn-sm btn-success" onclick="savePemainRow(this)">Simpan</button></td>
            </tr>`;
        }
        el.innerHTML = `
          <div class="card">
            <h3>Data Pemain (Max 16)</h3>
            <table class="table">
              <thead><tr><th>ID</th><th>Nama</th><th>Punggung</th><th>No</th><th>Lahir</th><th>Ket</th><th></th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }).getKlubData(currentUser.idKlub);
    }).getPemainKlub(currentUser.idKlub);
  }

  function checkDuplicate(input, used) {
    const val = input.value;
    if (used.includes(val) && val) {
      showToast('ID Pemain sudah digunakan', 'danger');
      input.value = '';
    }
  }

  function savePemainRow(btn) {
    const row = btn.parentElement.parentElement;
    const data = {
      ID_PEMAIN: row.cells[0].querySelector('input').value,
      NAMA_LENGKAP: row.cells[1].querySelector('input').value,
      NAMA_PUNGGUNG: row.cells[2].querySelector('input').value,
      NO_PUNGGUNG: row.cells[3].querySelector('input').value,
      TANGGAL_LAHIR: row.cells[4].querySelector('input').value,
      KETERANGAN: row.cells[5].querySelector('input').value
    };
    if (!data.ID_PEMAIN) return showToast('ID Pemain wajib', 'danger');
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      if (res.success) showToast('Pemain disimpan');
      else showToast('Gagal', 'danger');
    }).savePemain(data, currentUser);
  }

  // === JADWAL & A3 ===
  function loadJadwal() {
    google.script.run.withSuccessHandler(jadwal => {
      let cards = '';
      jadwal.forEach(m => {
        if (m.ID_KLUB === currentUser.idKlub) {
          cards += `
            <div class="card match-card" onclick="openPendaftaran('${m.ID_PERTANDINGAN}')">
              <h4>${m.NAMA_KLUB}</h4>
              <p><strong>${m.TANGGAL_PERTANDINGAN}</strong><br>${m.TYPE_PERTANDINGAN}<br>Lokasi: ${m.LOKASI_PERTANDINGAN}</p>
            </div>`;
        }
      });
      $('page-jadwal').innerHTML = cards || '<div class="card"><p>Tidak ada jadwal.</p></div>';
    }).getJadwalByKlub(currentUser.idKlub);
  }

  function openPendaftaran(idPertandingan) {
    selectedMatch = idPertandingan;
    google.script.run.withSuccessHandler(daftar => {
      google.script.run.withSuccessHandler(pemain => {
        let rows = '';
        const usedIds = daftar.map(d => d.ID_PEMAIN);
        for (let i = 0; i < 25; i++) {
          const d = daftar[i] || {};
          const options = pemain.map(p => `<option value="${p.ID_PEMAIN}">${p.ID_PEMAIN} - ${p.NAMA_PUNGGUNG}</option>`).join('');
          rows += `
            <tr>
              <td><select class="form-control" onchange="fillPemain(this)">${options}</select></td>
              <td><input value="${d.NAMA_PUNGGUNG || ''}" class="form-control"></td>
              <td><input type="number" value="${d.NO_PUNGGUNG || ''}" class="form-control"></td>
              <td><input value="${d.POSISI || ''}" class="form-control"></td>
              <td><select class="form-control"><option>PEMAIN UTAMA</option><option>PEMAIN CADANGAN</option></select></td>
              <td><button class="btn btn-sm btn-success" onclick="saveDaftarRow(this)">Simpan</button></td>
            </tr>`;
        }
        $('page-jadwal').innerHTML = `
          <div class="card">
            <button class="btn btn-sm btn-warning" onclick="loadJadwal()">Kembali</button>
            <h3>Pendaftaran - ${idPertandingan}</h3>
            <table class="table">
              <thead><tr><th>ID Pemain</th><th>Nama Punggung</th><th>No</th><th>Posisi</th><th>Tipe</th><th></th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }).getPemainKlub(currentUser.idKlub);
    }).getPendaftaran(idPertandingan, currentUser.idKlub);
  }

  function fillPemain(select) {
    const row = select.parentElement.parentElement;
    const id = select.value;
    google.script.run.withSuccessHandler(p => {
      if (p) {
        row.cells[1].querySelector('input').value = p.NAMA_PUNGGUNG;
        row.cells[2].querySelector('input').value = p.NO_PUNGGUNG;
        row.cells[3].querySelector('input').value = p.POSISI || '';
      }
    }).getPemainById(id, currentUser.idKlub); // Anda perlu tambahkan fungsi ini di backend
  }

  function saveDaftarRow(btn) {
    const row = btn.parentElement.parentElement;
    const data = {
      ID_PERTANDINGAN: selectedMatch,
      ID_KLUB: currentUser.idKlub,
      ID_PEMAIN: row.cells[0].querySelector('select').value,
      NAMA_PUNGGUNG: row.cells[1].querySelector('input').value,
      NO_PUNGGUNG: row.cells[2].querySelector('input').value,
      POSISI: row.cells[3].querySelector('input').value,
      TIPE_PEMAIN: row.cells[4].querySelector('select').value
    };
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      showToast(res.success ? 'Tersimpan' : 'Gagal', res.success ? 'success' : 'danger');
    }).savePendaftaran(data, currentUser);
  }

  // === BERITA ===
  function loadBerita() {
    google.script.run.withSuccessHandler(berita => {
      let list = '';
      berita.forEach(b => {
        list += `
          <div class="card">
            <h4>${b.judul}</h4>
            <p><small>${b.tanggal} - ${b.penulis}</small></p>
            <p>${b.isi}</p>
            ${b.foto ? `<img src="${b.foto}" class="img-preview">` : ''}
          </div>`;
      });
      $('page-berita').innerHTML = `
        <div class="card">
          <button class="btn btn-primary" onclick="openBeritaForm()">+ Berita Baru</button>
        </div>
        ${list}`;
    }).getBerita();
  }

  function openBeritaForm() {
    $('page-berita').innerHTML = `
      <div class="card">
        <h3>Tulis Berita</h3>
        <div class="form-group"><label>Judul</label><input id="judulBerita" class="form-control"></div>
        <div class="form-group"><label>Isi</label><textarea id="isiBerita" rows="5" class="form-control"></textarea></div>
        <div class="form-group"><label>Foto</label><input type="file" id="fotoBerita" accept="image/*"></div>
        <button class="btn btn-success" onclick="saveBerita()">Publish</button>
        <button class="btn btn-danger" onclick="loadBerita()">Batal</button>
      </div>`;
  }

  async function saveBerita() {
    const judul = $('judulBerita').value;
    const isi = $('isiBerita').value;
    const file = $('fotoBerita').files[0];
    let fotoUrl = '';
    if (file) {
      const form = new FormData();
      form.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: form });
      const json = await res.json();
      fotoUrl = json.data.url;
    }
    showLoading();
    google.script.run.withSuccessHandler(res => {
      showLoading(false);
      if (res.success) {
        showToast('Berita dipublish');
        loadBerita();
      }
    }).saveBerita({ JUDUL_BERITA: judul, ISI_BERITA: isi, POTO_URL: fotoUrl }, currentUser);
  }

  // === CHAT ===
  function loadChatList() {
    google.script.run.withSuccessHandler(users => {
      google.script.run.withSuccessHandler(active => {
        const activeSet = new Set(active.map(u => u.username));
        let list = '';
        users.forEach(u => {
          if (u.username !== currentUser.username) {
            const isActive = activeSet.has(u.username);
            list += `
              <div class="card" onclick="openChat('${u.username}', '${u.namaLengkap}')">
                <div style="display:flex; align-items:center;">
                  <div style="position:relative;">
                    <i class="fas fa-user-circle fa-2x" style="color:#ccc"></i>
                    ${isActive ? '<div class="online-dot"></div>' : ''}
                  </div>
                  <div style="margin-left:1rem;">
                    <strong>${u.namaLengkap}</strong><br>
                    <small>${u.tipeUser} - ${u.namaKlub}</small>
                  </div>
                </div>
              </div>`;
          }
        });
        $('page-chat').innerHTML = list || '<div class="card"><p>Tidak ada user lain.</p></div>';
      }).getActiveUsers();
    }).getAllUsers();
  }

  function openChat(username, nama) {
    chatWith = { username, nama };
    showPage('chat-detail');
    loadChatDetail();
    setInterval(loadChatDetail, 3000);
  }

  function loadChatDetail() {
    google.script.run.withSuccessHandler(msgs => {
      let chat = '';
      msgs.forEach(m => {
        const isSent = m.pengirim === currentUser.username;
        chat += `
          <div class="msg ${isSent ? 'sent' : 'received'}">
            ${m.pesan}
            <div class="msg-time">${new Date(m.timestamp).toLocaleTimeString()}</div>
          </div>`;
      });
      const el = $('page-chat-detail');
      el.innerHTML = `
        <div class="card">
          <button class="btn btn-sm btn-warning" onclick="showPage('chat')">Kembali</button>
          <h3>Chat dengan ${chatWith.nama}</h3>
          <div class="chat-box" id="chatBox">${chat}</div>
          <div style="display:flex; gap:0.5rem;">
            <input id="msgInput" placeholder="Ketik pesan..." class="form-control" onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()">Kirim</button>
          </div>
        </div>`;
      $('chatBox').scrollTop = $('chatBox').scrollHeight;
    }).getChatHistory(currentUser.username, chatWith.username);
  }

  function sendMessage() {
    const input = $('msgInput');
    const msg = input.value.trim();
    if (!msg) return;
    google.script.run.sendMessage(currentUser.username, chatWith.username, msg);
    input.value = '';
    setTimeout(loadChatDetail, 500);
  }

  function refreshChatBadge() {
    if (!currentUser) return;
    google.script.run.withSuccessHandler(count => {
      const badge = $('chatBadge');
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.remove('d-none');
      } else badge.classList.add('d-none');
    }).getUnreadCount(currentUser.username);
  }
</script>

<!-- GANTI DENGAN URL WEB APP ANDA -->
<script src="https://script.google.com/macros/s/AKfycbx05ahOZT41R6hW-DcvuXGJRcY3nM-apyne08nsLFk672iH6HMjRPsvsBktg7Y_jAlx/exec" id="gas-script"></script>
</body>
</html>
